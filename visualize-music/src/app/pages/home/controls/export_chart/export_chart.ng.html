<div class="">
  <p-button (click)="showDialog()" [label]="getExportLabel()" />
  <p-dialog
    header="Export Preview"
    [modal]="true"
    [(visible)]="visible"
    [style]="{ width: '95%', 'max-width': '850px' }"
  >
    <main class="export-container" #exportContainer>
      @if (currentWeekDate) {
        <h1 class="export-container-title">
          Your Tops
          {{ (currentEntityType$ | async) == "tracks" ? "Songs" : "Artists" }}:
          Week of {{ currentWeekDate | date: "longDate" }}
        </h1>
        @if (trackingStartDate$ | async; as trackingStartDate) {
          @if (trackingStartDate == "all-time") {
            <p class="export-container-subtitle">
              Data is cumalitive across all-time
            </p>
          } @else if (trackingStartDate == "year-to-date") {
            <p class="export-container-subtitle">
              Data spans the beginning of {{ currentYear }} to
              {{ currentWeekDate | date: "longDate" }}
            </p>
          } @else {
            <p class="export-container-subtitle">
              Data spans from
              {{ trackingStartDate | date: "longDate" }} to
              {{ currentWeekDate | date: "longDate" }}
            </p>
          }
        }
        <p-table [value]="currentWeekData" size="small" class="export-table">
          <ng-template #header>
            <tr>
              <th class="mobile-header border-wall-top-left">Rank</th>
              <th class="mobile-header border-wall-top">Art</th>
              <th class="mobile-header text-center border-wall-top">+/-</th>
              @if (currentEntityType$ | async; as entityType) {
                <th class="mobile-header border-wall-top">
                  {{ entityType == "tracks" ? "Song" : "Artist" }}
                </th>
              }
              <th class="mobile-header text-center border-wall-top">Plays</th>
              <th class="mobile-header text-center border-wall-top">% Î”</th>
              <th class="mobile-header text-center border-wall-top">Peak</th>
              <th class="mobile-header text-center border-wall-top-right">
                Woc
              </th>
            </tr>
          </ng-template>
          <ng-template #body let-item let-rowIndex="rowIndex">
            <tr>
              <!-- Rank -->
              <td
                class="mobile-cell {{
                  currentWeekData.length - 1 == rowIndex
                    ? 'border-wall-bottom-left'
                    : 'border-wall-left'
                }}"
              >
                {{ item.rank }}
              </td>
              <!-- Art -->
              <td
                class="{{
                  currentWeekData.length - 1 == rowIndex
                    ? 'border-wall-bottom'
                    : ''
                }}"
                [style]="{
                  padding: 0,
                }"
              >
                @if (getImageProperties(item); as imageProperties) {
                  @if (imageProperties.url) {
                    <img
                      width="48px"
                      height="48px"
                      [src]="imageProperties.url"
                      [alt]="imageProperties.alt"
                      (error)="imageProperties.error($event)"
                      loading="lazy"
                    />
                  } @else {
                    <div class="list-image-placeholder">
                      {{ imageProperties.initials }}
                    </div>
                  }
                }
              </td>
              <!-- Rank Difference -->
              <td
                class="mobile-cell text-center {{
                  currentWeekData.length - 1 == rowIndex
                    ? 'border-wall-bottom'
                    : ''
                }}"
                [ngStyle]="getLastWeekStyle(item.rankStatus)"
              >
                {{ getLastWeekDiff(item.rankStatus) }}
              </td>
              <!-- Song/Artist -->
              <td
                class="{{
                  currentWeekData.length - 1 == rowIndex
                    ? 'border-wall-bottom'
                    : ''
                }}"
                [ngStyle]="getLastWeekDiffBackgroundColor(item.rankStatus)"
              >
                <p class="title">{{ item.name }}</p>
                @if (item.artistName) {
                  <p class="subtitle">{{ item.artistName }}</p>
                }
              </td>
              <!-- Plays -->
              <td
                class="text-center mobile-cell {{
                  currentWeekData.length - 1 == rowIndex
                    ? 'border-wall-bottom'
                    : ''
                }}"
              >
                {{ item.plays }}
              </td>
              <!-- % Change -->
              <td
                class="text-center mobile-cell {{
                  currentWeekData.length - 1 == rowIndex
                    ? 'border-wall-bottom'
                    : ''
                }}"
                [ngStyle]="getExportRowBackgroundColor(item.playPercentChange)"
              >
                @if (item.playPercentChange != inf) {
                  {{ item.playPercentChange > 0 ? "+" : ""
                  }}{{ item.playPercentChange | number: "1.0-1" }}%
                } @else {
                  --
                }
              </td>
              <!-- Peak -->
              <td
                class="text-center mobile-cell {{
                  currentWeekData.length - 1 == rowIndex
                    ? 'border-wall-bottom'
                    : ''
                }} {{ item.peak == item.rank ? 'peak-cell' : '' }}"
              >
                {{ item.peak }}
              </td>
              <!-- Weeks on Chart -->
              <td
                class="text-center mobile-cell {{
                  currentWeekData.length - 1 == rowIndex
                    ? 'border-wall-bottom-right'
                    : 'border-wall-right'
                }} {{ item.hasHighestWoc ? 'highest-woc-cell' : '' }}"
              >
                {{ item.weeksOnChart }}
              </td>
            </tr>
          </ng-template>
        </p-table>
        <!-- Needed so the image does not cut the bottom-->
        <br /><br />
      }
    </main>
    <ng-template #footer>
      <p-button
        [disabled]="isExporting$ | async"
        class="export-image-button"
        [label]="(isExporting$ | async) ? 'Exporting' : 'Generate Image'"
        (onClick)="exportImage()"
      ></p-button>
    </ng-template>
  </p-dialog>
</div>
